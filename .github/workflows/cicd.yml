name: CI/CD Pipeline com Infraestrutura como C√≥digo (OCI)

on:
  push:
    branches:
      - main 

env:
  IMAGE_NAME: ${{ secrets.IMAGE_NAME }} 
  IMAGE_TAG: ${{ github.sha }}
  SERVER_APP_PATH: /home/ubuntu/meu-app # Caminho na VM para o deploy

jobs:
  # 1. Job de Testes (CI)
  test:
    name: üß™ Run tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      - name: Install dependencies
        run: npm ci
      - name: Run tests
        run: npm test
      
  # 2. Job de Constru√ß√£o e Publica√ß√£o (CI)
  build_and_push:
    name: üèóÔ∏è Build & Push Docker Image
    needs: test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
      - name: Build and Push
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}
            ${{ env.IMAGE_NAME }}:latest

  # 3. Job de Provisionamento da Infraestrutura (IaC)
  provision_infra:
    name: ‚öôÔ∏è Provision Infra (Terraform Apply - OCI)
    runs-on: ubuntu-latest
    needs: build_and_push 
    outputs:
      server_ip: ${{ steps.output-ip.outputs.ip }} # Exporta o IP din√¢mico
      
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.5.0 

      # CRIA ARQUIVO DE CHAVE PRIVADA DE API (Para autentica√ß√£o OCI)
      - name: Create OCI API Private Key File
        run: |
          echo "${{ secrets.OCI_API_PRIVATE_KEY }}" > oci_api_key.pem
          chmod 600 oci_api_key.pem

      # üö® CORRE√á√ÉO: Inicializa√ß√£o em duas etapas para resolver erro de backend
      - name: Terraform Init (No Backend)
        run: terraform init -backend=false
        working-directory: ./terraform

      - name: Terraform Init (Migrate Backend)
        run: terraform init
        working-directory: ./terraform
      
      - name: Terraform Apply
        id: apply
        run: |
          # Executa o Apply, passando os 8 Secrets OCI/SSH como vari√°veis
          terraform apply -auto-approve \
            -var "tenancy_ocid=${{ secrets.OCI_TENANCY_OCID }}" \
            -var "user_ocid=${{ secrets.OCI_USER_OCID }}" \
            -var "fingerprint=${{ secrets.OCI_FINGERPRINT }}" \
            -var "private_key_path=oci_api_key.pem" \
            -var "region=${{ secrets.OCI_REGION }}" \
            -var "compartment_ocid=${{ secrets.OCI_COMPARTMENT_OCID }}" \
            -var "subnet_ocid=${{ secrets.OCI_SUBNET_OCID }}" \
            -var "ssh_authorized_keys=${{ secrets.SSH_PUBLIC_KEY }}"
        working-directory: ./terraform
        
      - name: Extract Public IP Output
        id: output-ip
        run: |
          # Captura o IP gerado pelo outputs.tf
          IP=$(terraform output -raw server_public_ip)
          echo "ip=$IP" >> $GITHUB_OUTPUT
        working-directory: ./terraform

  # 4. Job de Deploy da Aplica√ß√£o (CD)
  deploy:
    name: üöÄ Deploy to Server
    needs: provision_infra # Depende da infra ser criada
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        
      - name: Deploy and Restart via SSH
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ needs.provision_infra.outputs.server_ip }} 
          username: ubuntu # Usu√°rio padr√£o
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            echo "Aguardando 60s para o Cloud-Init finalizar a instala√ß√£o do Docker..."
            sleep 60 # Espera a instala√ß√£o do Docker/Git
            
            cd ${{ env.SERVER_APP_PATH }}
            git pull origin main
            
            export IMAGE_TAG=${{ github.sha }}
            
            # Comandos corrigidos (Docker Run)
            sudo docker stop meu-app-prod || true
            sudo docker rm meu-app-prod || true
            
            sudo docker run -d --name meu-app-prod \
              -p 3000:3000 \
              --restart unless-stopped \
              --env-file .env \
              ${{ secrets.IMAGE_NAME }}:${{ env.IMAGE_TAG }}
              
            echo "Deploy conclu√≠do com sucesso!"