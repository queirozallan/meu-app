name: CI/CD Pipeline com Infraestrutura como CÃ³digo (OCI)

on:
  push:
    branches:
      - main 

env:
  IMAGE_NAME: ${{ secrets.IMAGE_NAME }} 
  IMAGE_TAG: ${{ github.sha }}
  SERVER_APP_PATH: /home/ubuntu/meu-app 

jobs:
  test:
    name: ðŸ§ª Run tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      - name: Install dependencies
        run: npm ci
      - name: Run tests
        run: npm test
      
  build_and_push:
    name: ðŸ—ï¸ Build & Push Docker Image
    needs: test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
      - name: Build and Push
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}
            ${{ env.IMAGE_NAME }}:latest

  provision_infra:
    name: âš™ï¸ Provision Infra (Terraform Apply - OCI)
    runs-on: ubuntu-latest
    needs: build_and_push 
    outputs:
      server_ip: ${{ steps.output-ip.outputs.ip }}
      
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.5.0 

      - name: Create OCI API Private Key File
        run: |
          echo "${{ secrets.OCI_API_PRIVATE_KEY }}" > oci_api_key.pem
          chmod 600 oci_api_key.pem

      - name: Terraform Init
        run: terraform init
        working-directory: ./terraform

      - name: Terraform Apply
        id: apply
        run: |
          # ðŸš¨ 2. Executa o Apply, passando os 8 Secrets OCI/SSH para criar a VM
          terraform apply -auto-approve \
            -var "tenancy_ocid=${{ secrets.OCI_TENANCY_OCID }}" \
            -var "user_ocid=${{ secrets.OCI_USER_OCID }}" \
            -var "fingerprint=${{ secrets.OCI_FINGERPRINT }}" \
            -var "private_key_path=oci_api_key.pem" \
            -var "region=${{ secrets.OCI_REGION }}" \
            -var "compartment_ocid=${{ secrets.OCI_COMPARTMENT_OCID }}" \
            -var "subnet_ocid=${{ secrets.OCI_SUBNET_OCID }}" \
            -var "ssh_authorized_keys=${{ secrets.SSH_PUBLIC_KEY }}"
        working-directory: ./terraform
        
      - name: Extract Public IP Output
        id: output-ip
        run: |
          IP=$(terraform output -raw server_public_ip)
          echo "ip=$IP" >> $GITHUB_OUTPUT
        working-directory: ./terraform

  deploy:
    name: ðŸš€ Deploy to Server
    needs: provision_infra 
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        
      - name: Deploy and Restart via SSH
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ needs.provision_infra.outputs.server_ip }} 
          username: ubuntu 
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            echo "Aguardando 60s para o Cloud-Init finalizar a instalaÃ§Ã£o do Docker..."
            sleep 60 # NecessÃ¡rio para Docker/Git estarem instalados
            
            cd ${{ env.SERVER_APP_PATH }}
            git pull origin main
            
            export IMAGE_TAG=${{ github.sha }}
            
            # ðŸš¨ 4. COMANDOS CORRIGIDOS (Docker Run, que funciona)
            sudo docker stop meu-app-prod || true
            sudo docker rm meu-app-prod || true
            
            sudo docker run -d --name meu-app-prod \
              -p 3000:3000 \
              --restart unless-stopped \
              --env-file .env \
              ${{ secrets.IMAGE_NAME }}:${{ env.IMAGE_TAG }}
              
            echo "Deploy concluÃ­do com sucesso!"